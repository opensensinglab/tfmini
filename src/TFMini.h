/*
Arduino driver for Benewake TFMini time-of-flight distance sensor. 
by Peter Jansen (December 11/2017)
This code is open source software in the public domain.

THIS SOFTWARE IS PROVIDED ''AS IS'' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
DISCLAIMED. IN NO EVENT SHALL THE AUTHOR(S) BE LIABLE FOR ANY
DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
(INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.  

The names of the contributors may not be used to endorse or promote products
derived from this software without specific prior written permission. 
*/

#if (ARDUINO >= 100)
#include "Arduino.h"
#else
#include "WProgram.h"
#endif

// Defines
#define TFMINI_BAUDRATE 115200
#define TFMINI_DEBUGMODE 0

// The frame size is nominally 9 characters, but we don't include the first two 0x59's marking the start of the frame
#define TFMINI_FRAME_SIZE 7

// Timeouts
#define TFMINI_MAXBYTESBEFOREHEADER 30
#define TFMINI_MAX_MEASUREMENT_ATTEMPTS 10

// States
#define READY 0
#define ERROR_SERIAL_NOHEADER 1
#define ERROR_SERIAL_BADCHECKSUM 2
#define ERROR_SERIAL_TOOMANYTRIES 3
#define MEASUREMENT_OK 10

enum MODE
{
  ZERO = 0x00,   // for 0-2m
  SHORT = 0x02,  // for 0-5m
  MIDDLE = 0x03, // for 0.5-5m
  LONG = 0x07    // for 1-12m
};

//
// Driver Class Definition
//
class TFMini
{
public:
  TFMini(void);

  // Configuration
  boolean begin(Stream *_streamPtr);
  void setSingleScanMode();
  void setMeasurementMode(MODE _mode);
  void setRangeLimit(uint16_t range);
  void setSignalThreshold(uint8_t min, uint16_t max);

  // Data collection
  uint16_t getDistance();
  uint16_t getRecentSignalStrength();
  uint8_t getMode();
  void externalTrigger();

private:
  Stream *streamPtr;
  int state;
  uint16_t distance;
  uint16_t strength;
  uint8_t mode;

  // Low-level communication
  void setStandardOutputMode();
  void setConfigMode();
  void unsetConfigMode();
  int takeMeasurement();
};
